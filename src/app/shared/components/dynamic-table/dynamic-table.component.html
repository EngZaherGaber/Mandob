<p-table #dt (onContextMenuSelect)="changeVisible()" [(contextMenuSelection)]="selectedItem" [value]="body.data"
    [paginator]="withPaginator" [rowHover]="true" [rows]="withPaginator ? 10 : totalRecords"
    [rowsPerPageOptions]="[5,10,25,50,100,200,500,800]" [scrollable]="true"
    [alwaysShowPaginator]="dt.value ? dt.value.length > 0 : false" [exportFilename]="tableName" [lazy]="lazyLoading"
    [size]="'small'" stripedRows (onLazyLoad)="loadCarsLazy($event)" [scrollHeight]="scrollHeight"
    (onRowExpand)="onRowExpandHandler($event)" [expandedRowKeys]="expandedRows" sortMode="multiple"
    [paginatorDropdownAppendTo]="'body'" [columns]="body.columns" [dataKey]="dataKey" [filterDelay]="0"
    [totalRecords]="totalRecords" [showLoader]="false" [loading]="body.loading" [showLoader]="true" [rowHover]="true"
    [responsive]="true" [resizableColumns]="true" [filters]="filters"
    currentPageReportTemplate="Showing {first} to {last} of {totalRecords} entries" columnResizeMode="expand"
    [showCurrentPageReport]="true" [autoLayout]="true" [globalFilterFields]="['Name']"
    [tableStyle]="{ 'min-width': '50rem'}">
    <ng-template pTemplate="caption">
        @if (showHeader) {
        <p-toolbar>
            <ng-template #start>
                @if (captionButton && captionButton.length > 0) {
                @for (btn of captionButton; track $index) {
                @if (btn && ((btn.showCommand && btn.showCommand(body.data) ) || (!btn.showCommand && true)) &&
                btn.isShow) {
                @if(btn.permission){
                <p-button size="small" [severity]="'secondary'" [pTooltip]="btn.tooltip" [icon]="btn.icon ?? ''"
                    (click)="btn.command ? btn.command(body.data) : null" />

                }@else {
                <p-button size="small" [severity]="'secondary'" [pTooltip]="btn.tooltip" [icon]="btn.icon ?? ''"
                    (click)="btn.command ? btn.command(body.data) : null" />
                }
                }
                }
                }
            </ng-template>
            <ng-template #end>
                <p-button size="small" icon="pi pi-filter" pTooltip="Use custom filters"
                    (click)="filterdMode = !filterdMode" severity="secondary" />
                <p-button size="small" icon="pi pi-filter-slash" pTooltip="Clear filters"
                    (click)="dt.clear();clearFilter()" severity="secondary" />
                @if(dt.value && dt.value.length > 0){
                <p-button size="small" pTooltip="XLS" severity="secondary" icon="pi pi-file-excel"
                    (onClick)="exportExcel()" />
                }
                <p-multiselect size="small" appendTo="body" [options]="columns" [(ngModel)]="selectedColumns"
                    placeholder="Select Columns" />

            </ng-template>
        </p-toolbar>
        }
    </ng-template>
    <ng-template pTemplate="header" let-columns>
        <tr pFrozenRow>
            <th pFrozenColumn style="max-width: 250px !important;" [class]="!firstColumn ? 'd-none' : ''">
                <div class="d-flex justify-content-center">
                    <p-button icon="pi pi-filter" [rounded]="true" [text]="true" pTooltip="Use custom filters"
                        (click)="filterdMode = !filterdMode" severity="primary" />
                    <p-button icon="pi pi-filter-slash" [rounded]="true" [text]="true" pTooltip="Clear filters"
                        (click)="dt.clear();clearFilter()" severity="secondary" />
                </div>
            </th>
            @if (imageField) {
            <th></th>
            }
            @for (col of columns; track $index) {
            @if (isSelect(col.header)) {
            <th pResizableColumn [pSortableColumn]="col.field"
                [style]="col.headerType === 'bool' ? {'justify-content':'center'} : ''">
                <div class="d-flex justify-content-between align-items-center">
                    <small>{{col.header}}</small>
                    @if(col.headerType !== 'img' && col.headerType !== 'nest' && col.headerType !== 'json' ){
                    <p-sortIcon [field]="col.field"></p-sortIcon>
                    }
                </div>
            </th>
            }
            }
        </tr>
        @if (filterdMode) {
        <tr pFrozenRow>
            <th [class]="!firstColumn ? 'd-none' : ''"></th>
            @if (imageField) {
            <th></th>
            }
            @for (col of columns; track $index) {
            @if(isSelect(col.header)){
            <th pResizableColumn [ngClass]="col.headerType === 'bool' ? 'bool-cell' : ''"
                [style]="col.headerType === 'bool' ? {'justify-content':'center'} : ''">
                <div [class]="'filter-div ' + col.headerType">
                    @switch (col.headerType) {
                    @case ('bool') {
                    <p-columnFilter type="boolean" [matchMode]="'equals'" [field]="col.field"
                        [placeholder]="col.header"></p-columnFilter>
                    }
                    @case ('toggle') {
                    <p-columnFilter type="boolean" [matchMode]="'equals'" [field]="col.field"
                        [placeholder]="col.header"></p-columnFilter>
                    }
                    @case ('datetime') {
                    <p-columnFilter type="date" [field]="col.field" [placeholder]="col.header"
                        appendTo="body"></p-columnFilter>
                    }
                    @case ('float') {
                    <p-columnFilter type="numeric" [maxFractionDigits]="2" [field]="col.field"
                        [placeholder]="col.header"></p-columnFilter>
                    }
                    @case ('int') {
                    <p-columnFilter type="numeric" [useGrouping]="false" [field]="col.field"
                        [placeholder]="col.header"></p-columnFilter>
                    }
                    @case ('currency') {
                    <p-columnFilter type="numeric" [useGrouping]="false" [field]="col.field"
                        [placeholder]="col.header"></p-columnFilter>
                    }
                    @case ('img') {

                    }@case ('nest') {

                    }@case ('html') {

                    <p-columnFilter type="text" [field]="col.field" [placeholder]="col.header" matchMode="contains"
                        [matchModeOptions]="[
    { label: 'Contains', value: 'contains' },
    { label: 'Not contains', value: 'notContains' }
  ]"></p-columnFilter>
                    }@case ('json') {

                    }@default {
                    <p-columnFilter type="text" [field]="col.field" [placeholder]="col.header"></p-columnFilter>
                    }
                    }

                </div>
            </th>
            }
            }
        </tr>
        }
    </ng-template>

    <ng-template pTemplate="body" let-rowData let-columns="columns" let-index let-expanded="expanded">
        @if ((dt.value ? dt.value.length > 0 : false)) {
        <tr [pContextMenuRow]="rowData" [ngStyle]="changeColor(rowData)">
            <td pFrozenColumn [class]="!firstColumn ? 'd-none' : ''" style="max-width: 250px !important;">
                <div class="d-flex jsutify-content-end align-items-center gap-2 button-cell">
                    @if (expandedTable) {
                    <p-button [text]="true" [pRowToggler]="rowData" severity="secondary" pTooltip="توسيع"
                        [icon]="expanded ? 'pi pi-chevron-down' : 'pi pi-chevron-right'" [rounded]="true"></p-button>
                    }
                    @for (btn of rowData.buttons; track $index) {
                    @if ((btn.showCommand && btn.showCommand(rowData)) || btn.isShow) {
                    @if (btn.permission) {
                    <p-button [text]="true" size="small" [severity]="'secondary'" [rounded]="true"
                        [pTooltip]="btn.tooltip" [icon]="btn.icon ?? ''"
                        (click)="btn.command(rowData,rowData.buttons,dt);hitAction.emit({key:btn.key,rowDataId:rowData.Id})" />
                    }@else {
                    <p-button [severity]="'secondary'" [rounded]="true" [pTooltip]="btn.tooltip" [icon]="btn.icon ?? ''"
                        (click)="btn.command(rowData,rowData.buttons,dt);hitAction.emit({key:btn.key,rowDataId:rowData.Id})" />
                    }
                    }
                    }
                </div>
            </td>
            @if (imageField) {
            <td class="d-flex justify-content-center">
                @if(getImageValue(rowData,imageField)){
                <p-avatar [image]="getImageValue(rowData,imageField)" size="xlarge" shape="circle" />
                }@else {
                <p-skeleton shape="circle" size="64px" />
                }
            </td>
            }
            @for (col of columns; track $index) {
            @if (isSelect(col.header)) {
            <td>
                <div class="d-flex"
                    [ngClass]="(col.headerType === 'bool' || col.headerType === 'img' || col.headerType === 'tag' || col.headerType === 'toggle') ? 'bool-cell' : ''"
                    [style]="{'justify-content':getAlignment(col.field)}">
                    @if(col.headerType !== 'img'){

                    @switch (col.headerType) {
                    @case ('bool') {
                    <i class="pi"
                        [ngClass]="{'text-green-500 pi-check-circle': rowData[col.field],'text-red-500 pi-times-circle': !rowData[col.field]}"></i>
                    }
                    @case ('datetime') {
                    @if (rowData[col.field] !== null) {
                    <small>
                        {{ rowData[col.field] | date: 'dd-MM-yyyy'}}
                    </small>
                    }@else {
                    <small>
                        {{ rowData[col.field] }}
                    </small>
                    }
                    }
                    @case ('float') {
                    @if (rowData[col.field] !== null) {
                    <small>
                        {{ rowData[col.field] | number:'1.2-2'}}
                    </small>
                    }
                    }
                    @case ('currency') {
                    @if (rowData[col.field] !== null) {
                    <small>
                        {{ rowData[col.field] | number:'1.0-2'}}
                    </small>
                    }
                    }
                    @case ('json') {
                    <button pButton pRipple pTooltip="download JSON file" icon="pi pi-download"
                        (click)="downloadJSON(rowData[col.field])"></button>
                    }
                    @case ('tag') {
                    <p-tag [value]="rowData[col.field]" [severity]="getSeverity(rowData)" />
                    }
                    @case ('nest') {
                    <small>
                        {{getValueByPath(col.field,rowData)}}
                    </small>
                    }
                    @case ('html') {
                    <div [innerHTML]="rowData[col.field]"> </div>
                    }
                    @case ('toggle') {
                    @if (hasToggleShow(col.field,rowData)) {
                    <p-toggleswitch [pTooltip]="rowData[col.field] ? 'True': 'False'" [(ngModel)]=" rowData[col.field]"
                        [disabled]="hasToggledisable(col.field,rowData) ?? false"
                        (onChange)="handleChange($event,col.field,rowData)"></p-toggleswitch>
                    }@else {
                    <small>
                        {{rowData[col.field]}}
                    </small>
                    }
                    }
                    @default {
                    <small>
                        {{rowData[col.field]}}
                    </small>
                    }
                    }
                    }
                </div>
            </td>
            }
            }
        </tr>
        }

    </ng-template>

    <ng-template pTemplate="expandedrow" let-rowData>
        <tr class="expaned">
            <td [colSpan]="selectedColumns.length + 1" class="border-0">
                @if(rowExpansionContent){
                <ng-container *ngTemplateOutlet="rowExpansionContent; context: { item: rowData }">
                </ng-container>
                }
            </td>
        </tr>
    </ng-template>
    <ng-template #loadingicon style="width: 100%;height: 250px;">
        <img src="IconBlue.svg" width="200" alt="">
    </ng-template>
    <ng-template emptymessage>
        <tr>
            @if(dt.value){
            <td colspan="5">No Items found.</td>
            }@else {
            <td colspan="5">Something Wrong!.</td>
            }
        </tr>
    </ng-template>
    <ng-template pTemplate="summary">
        <ng-content select="[footer]"></ng-content>
    </ng-template>
</p-table>